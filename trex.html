<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T REXX - UVOGAMES</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #FFD700, #FF69B4, #8A2BE2, #00BFFF); /* Initial gradient */
            background-size: 400% 400%; /* For animation */
            animation: background-gradient 15s ease infinite; /* Smooth animation */
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation;
        }

        /* Background Gradient Animation */
        @keyframes background-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Header --- */
        .header {
            background-color: #222;
            color: #eee;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            z-index: 1000;
        }

        .header-title {
            font-size: 1.2em;
            font-weight: bold;
            letter-spacing: 2px;
            text-align: center;
            flex-grow: 1;
            margin-right: 40px;
        }

        .menu-button {
            background: none;
            border: none;
            color: #eee;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            z-index: 1001;
        }

        /* --- Main Game Container --- */
        .main-game-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* Arrange game area and jump button vertically */
            justify-content: center;
            align-items: center;
            padding: 10px; /* Some padding around the game */
            box-sizing: border-box;
        }

        /* --- Game Area (Canvas) --- */
        .game-area {
            position: relative;
            width: 100%;
            max-width: 600px; /* Game width on larger screens */
            height: 200px; /* Fixed game height */
            background-color: #e0f7fa;
            overflow: hidden;
            border-bottom: 2px solid #4CAF50;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            margin-bottom: 10px; /* Space below game area for jump button */
        }

        /* Ground Animation */
        .ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect width="20" height="20" fill="%238BC34A"/><rect x="0" y="10" width="20" height="10" fill="%23689F38"/></svg>');
            background-size: 20px 20px;
            background-repeat: repeat-x;
            animation: ground-move linear infinite;
        }

        @keyframes ground-move {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        /* --- Dino Styles --- */
        .dino {
            width: 50px;
            height: 50px;
            position: absolute;
            bottom: 20px;
            left: 50px;
            background-size: contain;
            background-repeat: no-repeat;
            image-rendering: pixelated;
        }

        /* Dino Running Animation */
        .dino.running {
            animation: dino-run 0.2s steps(2) infinite;
        }
        @keyframes dino-run {
            0% { background-image: var(--dino-run-1); }
            50% { background-image: var(--dino-run-2); }
            100% { background-image: var(--dino-run-1); }
        }

        /* Dino Jumping Image */
        .dino.jumping {
            background-image: var(--dino-jump) !important;
            animation: jump 0.6s cubic-bezier(0.2, 0.8, 0.4, 1) forwards;
        }

        @keyframes jump {
            0% { bottom: 20px; }
            50% { bottom: 120px; }
            100% { bottom: 20px; }
        }

        /* --- Obstacle Styles --- */
        .obstacle {
            width: 30px;
            height: 60px;
            position: absolute;
            bottom: 20px;
            right: -30px;
            background-size: contain;
            background-repeat: no-repeat;
            image-rendering: pixelated;
            animation: moveObstacle linear forwards;
        }

        .obstacle.cactus {
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200"><rect x="35" y="0" width="30" height="200" fill="%234CAF50"/><rect x="0" y="80" width="50" height="25" fill="%234CAF50"/><rect x="50" y="30" width="50" height="25" fill="%234CAF50"/></svg>');
        }
        .obstacle.bird {
            width: 40px;
            height: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><polygon points="0,50 20,20 80,20 100,50 80,80 20,80" fill="%23607D8B"/></svg>');
            animation: bird-flap 0.3s steps(1) infinite;
        }
        @keyframes bird-flap {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        /* --- Coin Styles --- */
        .coin {
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="gold"/><text x="50" y="65" font-family="Arial" font-size="60" fill="%23DAA520" text-anchor="middle">$</text></svg>');
            background-size: contain;
            position: absolute;
            bottom: 50px;
            right: -20px;
            animation: moveCoin linear forwards;
            image-rendering: pixelated;
        }

        /* --- Game Info (Score, Coins) --- */
        .game-info {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.9em;
            text-align: right;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            z-index: 10;
        }

        /* --- Jump Button Below Game --- */
        .jump-button-below {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background-color 0.2s, transform 0.1s;
            width: 90%;
            max-width: 300px;
        }

        .jump-button-below:active {
            background-color: #45a049;
            transform: translateY(2px);
        }

        /* --- Game Over Screen --- */
        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 10px;
            display: none;
            z-index: 999;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            width: 80%;
            max-width: 300px;
            box-sizing: border-box;
        }

        .game-over h2 {
            margin-top: 0;
            font-size: 1.5em;
            color: #FFEB3B;
        }

        .game-over p {
            margin: 10px 0;
            font-size: 0.8em;
        }

        .game-over button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .game-over button:hover {
            background-color: #45a049;
        }

        /* --- Left Navigation Menu --- */
        .nav-menu {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background-color: #333;
            color: white;
            padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.7);
            transition: left 0.3s ease-in-out;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .nav-menu.open {
            left: 0;
        }

        .nav-menu h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #FFEB3B;
        }

        .nav-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .nav-menu li {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #444;
            transition: background-color 0.2s;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }

        .nav-menu li:hover {
            background-color: #555;
        }

        .nav-menu .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .nav-menu .menu-section-title {
            padding: 10px 20px;
            font-weight: bold;
            background-color: #444;
            margin-top: 15px;
            margin-bottom: 5px;
            color: #90CAF9;
        }

        .nav-menu .game-info-footer {
            padding: 15px 20px;
            font-size: 0.8em;
            border-top: 1px solid #444;
            text-align: center;
        }

        .nav-menu button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px 20px;
            width: calc(100% - 40px);
            transition: background-color 0.2s;
        }
        .nav-menu button:hover {
            background-color: #0056b3;
        }

        /* Redeem Code Section */
        .redeem-section {
            padding: 15px 20px;
            border-top: 1px solid #444;
            margin-top: 15px;
        }
        .redeem-section input {
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 8px 10px;
            margin-bottom: 10px;
            border: 1px solid #555;
            background-color: #222;
            color: white;
            border-radius: 4px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8em;
            box-sizing: border-box;
        }
        .redeem-section button {
            width: 100%;
            margin: 0;
            padding: 10px 15px;
            background-color: #FF5722;
        }
        .redeem-section button:hover {
            background-color: #E64A19;
        }

        /* Skin/Mode specific styles for menu items */
        .skin-item img, .mode-item img {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            image-rendering: pixelated;
        }

        .skin-item .price {
            margin-left: auto;
            font-weight: bold;
            color: gold;
        }

        .skin-item.selected, .mode-item.selected {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .skin-item.selected .price {
            color: white;
        }

        .skin-item.locked, .mode-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .skin-item.locked .price {
            color: #ccc;
        }

        /* Overlay for menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* --- Specific Mode Visuals --- */
        .game-area.night-mode {
            background-color: #263238;
        }
        .game-area.night-mode .ground {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><rect width="20" height="20" fill="%23455A64"/><rect x="0" y="10" width="20" height="10" fill="%23263238"/></svg>');
        }
        .game-area.night-mode .game-info {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
        }
        .game-area.night-mode .obstacle.cactus {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 200"><rect x="35" y="0" width="30" height="200" fill="%23388E3C"/><rect x="0" y="80" width="50" height="25" fill="%23388E3C"/><rect x="50" y="30" width="50" height="25" fill="%23388E3C"/></svg>');
        }
    </style>
</head>
<body>

    <header class="header">
        <button class="menu-button" id="menuButton">☰</button>
        <span class="header-title">T REXX - UVOGAMES</span>
        <div style="width: 30px;"></div>
    </header>

    <div class="main-game-wrapper">
        <div class="game-area" id="gameArea">
            <div class="ground" id="ground"></div>
            <div class="dino" id="dino"></div>
            <div class="game-info">
                Score: <span id="score">0</span><br>
                Coins: <span id="coins">0</span>
            </div>
            <div class="game-over" id="gameOver">
                <h2>GAME OVER!</h2>
                <p>Your Score: <span id="finalScore">0</span></p>
                <p>Coins Earned: <span id="earnedCoins">0</span></p>
                <button id="restartButton">Restart</button>
            </div>
        </div>

        <button class="jump-button-below" id="jumpButtonBelow">JUMP</button>
    </div>

    <nav class="nav-menu" id="navMenu">
        <button class="close-button" id="closeMenuButton">&times;</button>
        <h3>Game Menu</h3>
        <ul>
            <li class="menu-section-title">Game Info</li>
            <li>Game Name: Dino Run</li>
            <li>Version: 1</li>
            <li>By: ADITdev</li>

            <li class="menu-section-title">Skins (<span id="currentSkinName">Default</span>)</li>
            <li class="skin-item" data-skin-id="default">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%234CAF50'/><circle cx='50' cy='20' r='10' fill='%23388E3C'/></svg>" alt="Default Dino"> Default Dino
            </li>
            <li class="skin-item" data-skin-id="red" data-price="50">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23F44336'/><circle cx='50' cy='20' r='10' fill='%23D32F2F'/></svg>" alt="Red Dino"> Red Dino <span class="price">50</span>
            </li>
            <li class="skin-item" data-skin-id="blue" data-price="75">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%232196F3'/><circle cx='50' cy='20' r='10' fill='%231976D2'/></svg>" alt="Blue Dino"> Blue Dino <span class="price">75</span>
            </li>
            <li class="skin-item" data-skin-id="yellow" data-price="100">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23FFEB3B'/><circle cx='50' cy='20' r='10' fill='%23FBC02D'/></svg>" alt="Yellow Dino"> Yellow Dino <span class="price">100</span>
            </li>
            <li class="skin-item" data-skin-id="purple" data-price="120">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%239C27B0'/><circle cx='50' cy='20' r='10' fill='%237B1FA2'/></svg>" alt="Purple Dino"> Purple Dino <span class="price">120</span>
            </li>
            <li class="skin-item" data-skin-id="black" data-price="150">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23212121'/><circle cx='50' cy='20' r='10' fill='%23000000'/></svg>" alt="Black Dino"> Black Dino <span class="price">150</span>
            </li>
            <li class="skin-item" data-skin-id="pink" data-price="170">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23E91E63'/><circle cx='50' cy='20' r='10' fill='%23C2185B'/></svg>" alt="Pink Dino"> Pink Dino <span class="price">170</span>
            </li>
            <li class="skin-item" data-skin-id="white" data-price="200">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23FAFAFA'/><circle cx='50' cy='20' r='10' fill='%23E0E0E0'/></svg>" alt="White Dino"> White Dino <span class="price">200</span>
            </li>
            <li class="skin-item" data-skin-id="gold" data-price="300">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='0' width='60' height='100' fill='%23FFD700'/><circle cx='50' cy='20' r='10' fill='%23DAA520'/></svg>" alt="Gold Dino"> Gold Dino <span class="price">300</span>
            </li>
            <li class="skin-item" data-skin-id="rainbow" data-price="500">
                 <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='rainbowGrad' x1='0%' y1='0%' x2='100%' y2='0%'><stop offset='0%' style='stop-color:red'/><stop offset='16%' style='stop-color:orange'/><stop offset='33%' style='stop-color:yellow'/><stop offset='50%' style='stop-color:green'/><stop offset='66%' style='stop-color:blue'/><stop offset='83%' style='stop-color:indigo'/><stop offset='100%' style='stop-color:violet'/></linearGradient></defs><rect x='20' y='0' width='60' height='100' fill='url(%23rainbowGrad)'/><circle cx='50' cy='20' r='10' fill='blue'/></svg>" alt="Rainbow Dino"> Rainbow Dino <span class="price">500</span>
            </li>

            <li class="menu-section-title">Modes (<span id="currentModeName">Normal</span>)</li>
            <li class="mode-item" data-mode-id="normal">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%238BC34A'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>N</text></svg>" alt="Normal Mode"> Normal Mode
            </li>
            <li class="mode-item" data-mode-id="fast" data-price="75">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23FFC107'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>F</text></svg>" alt="Fast Mode"> Fast Mode <span class="price">75</span>
            </li>
            <li class="mode-item" data-mode-id="slow" data-price="50">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%239E9E9E'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>S</text></svg>" alt="Slow Mode"> Slow Mode <span class="price">50</span>
            </li>
            <li class="mode-item" data-mode-id="obstacles" data-price="100">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23FF5722'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>O</text></svg>" alt="More Obstacles"> More Obstacles <span class="price">100</span>
            </li>
            <li class="mode-item" data-mode-id="coins" data-price="120">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='gold'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>C</text></svg>" alt="Coin Rush"> Coin Rush <span class="price">120</span>
            </li>
            <li class="mode-item" data-mode-id="night" data-price="150">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%233F51B5'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>N</text></svg>" alt="Night Mode"> Night Mode <span class="price">150</span>
            </li>
            <li class="mode-item" data-mode-id="low-gravity" data-price="170">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2300BCD4'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>G</text></svg>" alt="Low Gravity"> Low Gravity <span class="price">170</span>
            </li>
            <li class="mode-item" data-mode-id="tiny-obstacles" data-price="200">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23673AB7'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>T</text></svg>" alt="Tiny Obstacles"> Tiny Obstacles <span class="price">200</span>
            </li>
            <li class="mode-item" data-mode-id="giant-obstacles" data-price="250">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23795548'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>G</text></svg>" alt="Giant Obstacles"> Giant Obstacles <span class="price">250</span>
            </li>
            <li class="mode-item" data-mode-id="berserk" data-price="300">
                <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23E64A19'/><text x='50' y='60' font-family='Press Start 2P' font-size='30' fill='white' text-anchor='middle'>B</text></svg>" alt="Berserk Mode"> Berserk Mode <span class="price">300</span>
            </li>
        </ul>

        <div class="redeem-section">
            <h3 class="menu-section-title">Redeem Code</h3>
            <input type="text" id="redeemCodeInput" placeholder="Enter code">
            <button id="redeemButton">Redeem</button>
        </div>

        <div class="game-info-footer">
            <button id="backButton">Back to previous web</button>
        </div>
    </nav>

    <div class="overlay" id="overlay"></div>

    <script>
        // --- DOM Elements ---
        const dino = document.getElementById('dino');
        const gameArea = document.getElementById('gameArea');
        const gameOverScreen = document.getElementById('gameOver');
        const restartButton = document.getElementById('restartButton');
        const scoreDisplay = document.getElementById('score');
        const coinsDisplay = document.getElementById('coins');
        const finalScoreDisplay = document.getElementById('finalScore');
        const earnedCoinsDisplay = document.getElementById('earnedCoins');
        const jumpButtonBelow = document.getElementById('jumpButtonBelow'); // The new jump button

        const menuButton = document.getElementById('menuButton');
        const navMenu = document.getElementById('navMenu');
        const closeMenuButton = document.getElementById('closeMenuButton');
        const overlay = document.getElementById('overlay');
        const backButton = document.getElementById('backButton');

        const skinItems = document.querySelectorAll('.skin-item');
        const modeItems = document.querySelectorAll('.mode-item');
        const currentSkinNameDisplay = document.getElementById('currentSkinName');
        const currentModeNameDisplay = document.getElementById('currentModeName');

        const redeemCodeInput = document.getElementById('redeemCodeInput');
        const redeemButton = document.getElementById('redeemButton');

        // --- Game State Variables ---
        let isJumping = false;
        let gameOver = false;
        let score = 0;
        let coins = parseInt(localStorage.getItem('dinoCoins')) || 0;
        let gameSpeed = 5;
        let obstacleGenerationInterval = 1500;
        let obstacleTimer;
        let gameLoopTimer;
        const jumpAnimationDuration = 600; // Must match CSS animation duration

        // --- Persistent State from localStorage ---
        let currentSkinId = localStorage.getItem('dinoSkinId') || 'default';
        let currentModeId = localStorage.getItem('dinoModeId') || 'normal';
        let unlockedSkins = JSON.parse(localStorage.getItem('unlockedSkins')) || ['default'];
        let unlockedModes = JSON.parse(localStorage.getItem('unlockedModes')) || ['normal'];
        let redeemedCodes = JSON.parse(localStorage.getItem('redeemedCodes')) || []; // Track redeemed codes

        // --- Redeem Codes ---
        const redeemCodes = {
            '55555': 1000,
            '12345': 500,
            '11111': 500
        };

        // --- Game Data: Skins and Modes (Same as previous, omitted for brevity but included in full code) ---
        // (The skin and mode data objects are quite large, so I'm omitting them here to keep the explanation concise.
        // They are exactly as they were in the previous version, defining images and properties for each.)
        const skins = {
            'default': {
                name: 'Default Dino', price: 0,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%234CAF50"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23388E3C" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23388E3C"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%234CAF50"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23388E3C" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23388E3C"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%234CAF50"/><circle cx="70" cy="10" r="8" fill="%23388E3C"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'red': {
                name: 'Red Dino', price: 50,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23F44336"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23D32F2F" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23D32F2F"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23F44336"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23D32F2F" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23D32F2F"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23F44336"/><circle cx="70" cy="10" r="8" fill="%23D32F2F"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'blue': {
                name: 'Blue Dino', price: 75,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%232196F3"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%231976D2" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%231976D2"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%232196F3"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%231976D2" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%231976D2"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%232196F3"/><circle cx="70" cy="10" r="8" fill="%231976D2"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'yellow': {
                name: 'Yellow Dino', price: 100,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FFEB3B"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23FBC02D" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23FBC02D"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FFEB3B"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23FBC02D" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23FBC02D"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23FFEB3B"/><circle cx="70" cy="10" r="8" fill="%23FBC02D"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'purple': {
                name: 'Purple Dino', price: 120,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%239C27B0"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%237B1FA2" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%237B1FA2"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%239C27B0"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%237B1FA2" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%237B1FA2"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%239C27B0"/><circle cx="70" cy="10" r="8" fill="%237B1FA2"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'black': {
                name: 'Black Dino', price: 150,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23212121"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23000000" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23000000"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23212121"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23000000" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23000000"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23212121"/><circle cx="70" cy="10" r="8" fill="%23000000"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'pink': {
                name: 'Pink Dino', price: 170,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23E91E63"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23C2185B" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23C2185B"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23E91E63"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23C2185B" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23C2185B"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23E91E63"/><circle cx="70" cy="10" r="8" fill="%23C2185B"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'white': {
                name: 'White Dino', price: 200,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FAFAFA"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23E0E0E0" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23E0E0E0"/><circle cx="70" cy="30" r="3" fill="black"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FAFAFA"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23E0E0E0" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23E0E0E0"/><circle cx="70" cy="30" r="3" fill="black"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23FAFAFA"/><circle cx="70" cy="10" r="8" fill="%23E0E0E0"/><circle cx="70" cy="10" r="3" fill="black"/></svg>')`
            },
            'gold': {
                name: 'Gold Dino', price: 300,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FFD700"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="%23DAA520" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23DAA520"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="80" fill="%23FFD700"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="%23DAA520" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="%23DAA520"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="0" width="60" height="100" fill="%23FFD700"/><circle cx="70" cy="10" r="8" fill="%23DAA520"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            },
            'rainbow': {
                name: 'Rainbow Dino', price: 500,
                run1: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="rainbowRun1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:red"/><stop offset="16%" style="stop-color:orange"/><stop offset="33%" style="stop-color:yellow"/><stop offset="50%" style="stop-color:green"/><stop offset="66%" style="stop-color:blue"/><stop offset="83%" style="stop-color:indigo"/><stop offset="100%" style="stop-color:violet"/></linearGradient></defs><rect x="20" y="20" width="60" height="80" fill="url(%23rainbowRun1)"/><path d="M20,100 L25,90 L30,100 L35,90 L40,100" fill="none" stroke="black" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="black"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                run2: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="rainbowRun2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:red"/><stop offset="16%" style="stop-color:orange"/><stop offset="33%" style="stop-color:yellow"/><stop offset="50%" style="stop-color:green"/><stop offset="66%" style="stop-color:blue"/><stop offset="83%" style="stop-color:indigo"/><stop offset="100%" style="stop-color:violet"/></linearGradient></defs><rect x="20" y="20" width="60" height="80" fill="url(%23rainbowRun2)"/><path d="M20,90 L25,100 L30,90 L35,100 L40,90" fill="none" stroke="black" stroke-width="5"/><circle cx="70" cy="30" r="8" fill="black"/><circle cx="70" cy="30" r="3" fill="white"/></svg>')`,
                jump: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><linearGradient id="rainbowJump" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:red"/><stop offset="16%" style="stop-color:orange"/><stop offset="33%" style="stop-color:yellow"/><stop offset="50%" style="stop-color:green"/><stop offset="66%" style="stop-color:blue"/><stop offset="83%" style="stop-color:indigo"/><stop offset="100%" style="stop-color:violet"/></linearGradient></defs><rect x="20" y="0" width="60" height="100" fill="url(%23rainbowJump)"/><circle cx="70" cy="10" r="8" fill="black"/><circle cx="70" cy="10" r="3" fill="white"/></svg>')`
            }
        };

        const modes = {
            'normal': { name: 'Normal Mode', price: 0, speedMultiplier: 1, obstacleFrequency: 1, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1, nightMode: false },
            'fast': { name: 'Fast Mode', price: 75, speedMultiplier: 1.5, obstacleFrequency: 0.7, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1, nightMode: false },
            'slow': { name: 'Slow Mode', price: 50, speedMultiplier: 0.7, obstacleFrequency: 1.3, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1, nightMode: false },
            'obstacles': { name: 'More Obstacles', price: 100, speedMultiplier: 1, obstacleFrequency: 0.5, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1, nightMode: false },
            'coins': { name: 'Coin Rush', price: 120, speedMultiplier: 0.8, obstacleFrequency: 1.2, jumpHeightMultiplier: 1, coinRateMultiplier: 3, obstacleSize: 1, nightMode: false },
            'night': { name: 'Night Mode', price: 150, speedMultiplier: 1, obstacleFrequency: 1, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1, nightMode: true },
            'low-gravity': { name: 'Low Gravity', price: 170, speedMultiplier: 1, obstacleFrequency: 1, jumpHeightMultiplier: 1.5, coinRateMultiplier: 1, obstacleSize: 1, nightMode: false },
            'tiny-obstacles': { name: 'Tiny Obstacles', price: 200, speedMultiplier: 1.2, obstacleFrequency: 0.8, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 0.6, nightMode: false },
            'giant-obstacles': { name: 'Giant Obstacles', price: 250, speedMultiplier: 0.9, obstacleFrequency: 1, jumpHeightMultiplier: 1, coinRateMultiplier: 1, obstacleSize: 1.5, nightMode: false },
            'berserk': { name: 'Berserk Mode', price: 300, speedMultiplier: 2.0, obstacleFrequency: 0.4, jumpHeightMultiplier: 0.8, coinRateMultiplier: 1, obstacleSize: 1.2, nightMode: false }
        };

        // --- Game Functions ---

        function applySkin(skinId) {
            const skin = skins[skinId];
            if (!skin) return;

            document.documentElement.style.setProperty('--dino-run-1', skin.run1);
            document.documentElement.style.setProperty('--dino-run-2', skin.run2);
            document.documentElement.style.setProperty('--dino-jump', skin.jump);

            dino.classList.add('running');
            currentSkinId = skinId;
            localStorage.setItem('dinoSkinId', currentSkinId);
            currentSkinNameDisplay.textContent = skin.name;
            updateSkinSelectionUI();
        }

        function applyMode(modeId) {
            const mode = modes[modeId];
            if (!mode) return;

            currentModeId = modeId;
            localStorage.setItem('dinoModeId', currentModeId);
            currentModeNameDisplay.textContent = mode.name;
            updateModeSelectionUI();

            if (mode.nightMode) {
                gameArea.classList.add('night-mode');
            } else {
                gameArea.classList.remove('night-mode');
            }
            resetGame();
        }

        function jump() {
            if (!isJumping && !gameOver) {
                isJumping = true;
                dino.classList.remove('running');
                dino.classList.add('jumping');
                setTimeout(() => {
                    isJumping = false;
                    dino.classList.remove('jumping');
                    if (!gameOver) {
                        dino.classList.add('running');
                    }
                }, jumpAnimationDuration * modes[currentModeId].jumpHeightMultiplier);
            }
        }

        function createObstacle() {
            if (gameOver) return;

            const obstacle = document.createElement('div');
            const isBird = Math.random() < 0.2;

            obstacle.classList.add('obstacle');
            obstacle.classList.add(isBird ? 'bird' : 'cactus');

            let obstacleWidth = isBird ? 40 : 30 * modes[currentModeId].obstacleSize;
            let obstacleHeight = isBird ? 30 : 60 * modes[currentModeId].obstacleSize;
            let obstacleBottom = isBird ? Math.random() * 80 + 80 : 20;

            obstacle.style.width = `${obstacleWidth}px`;
            obstacle.style.height = `${obstacleHeight}px`;
            obstacle.style.bottom = `${obstacleBottom}px`;

            gameArea.appendChild(obstacle);

            const animationDuration = gameArea.offsetWidth / (gameSpeed * modes[currentModeId].speedMultiplier) / 10;
            obstacle.style.animationDuration = `${animationDuration}s`;
            obstacle.style.animationName = 'moveObstacle';
            obstacle.style.animationPlayState = 'running';

            const obstacleAnimationEnd = () => {
                if (obstacle.parentNode) {
                    obstacle.remove();
                }
            };
            obstacle.addEventListener('animationend', obstacleAnimationEnd);
            obstacle.addEventListener('webkitAnimationEnd', obstacleAnimationEnd);
        }

        function createCoin() {
            if (gameOver) return;
            if (Math.random() < 0.3 * modes[currentModeId].coinRateMultiplier) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                coin.style.bottom = `${Math.random() * 80 + 50}px`;
                gameArea.appendChild(coin);

                const animationDuration = gameArea.offsetWidth / (gameSpeed * modes[currentModeId].speedMultiplier) / 10;
                coin.style.animationDuration = `${animationDuration}s`;
                coin.style.animationName = 'moveCoin';
                coin.style.animationPlayState = 'running';

                const coinAnimationEnd = () => {
                    if (coin.parentNode) {
                        coin.remove();
                    }
                };
                coin.addEventListener('animationend', coinAnimationEnd);
                coin.addEventListener('webkitAnimationEnd', coinAnimationEnd);
            }
        }

        function checkCollision() {
            if (gameOver) return;

            const dinoRect = dino.getBoundingClientRect();
            const gameAreaRect = gameArea.getBoundingClientRect();

            const dinoRelativeRect = {
                left: dinoRect.left - gameAreaRect.left,
                right: dinoRect.right - gameAreaRect.left,
                top: dinoRect.top - gameAreaRect.top,
                bottom: dinoRect.bottom - gameAreaRect.top,
                width: dinoRect.width,
                height: dinoRect.height
            };

            const obstacles = document.querySelectorAll('.obstacle');
            obstacles.forEach(obstacle => {
                const obstacleRect = obstacle.getBoundingClientRect();
                const obstacleRelativeRect = {
                    left: obstacleRect.left - gameAreaRect.left,
                    right: obstacleRect.right - gameAreaRect.left,
                    top: obstacleRect.top - gameAreaRect.top,
                    bottom: obstacleRect.bottom - gameAreaRect.top,
                    width: obstacleRect.width,
                    height: obstacleRect.height
                };

                if (
                    dinoRelativeRect.right > obstacleRelativeRect.left &&
                    dinoRelativeRect.left < obstacleRelativeRect.right &&
                    dinoRelativeRect.bottom > obstacleRelativeRect.top &&
                    dinoRelativeRect.top < obstacleRelativeRect.bottom
                ) {
                    endGame();
                }
            });

            const coins = document.querySelectorAll('.coin');
            coins.forEach(coin => {
                const coinRect = coin.getBoundingClientRect();
                const coinRelativeRect = {
                    left: coinRect.left - gameAreaRect.left,
                    right: coinRect.right - gameAreaRect.left,
                    top: coinRect.top - gameAreaRect.top,
                    bottom: coinRect.bottom - gameAreaRect.top
                };

                if (
                    dinoRelativeRect.right > coinRelativeRect.left &&
                    dinoRelativeRect.left < coinRelativeRect.right &&
                    dinoRelativeRect.bottom > coinRelativeRect.top &&
                    dinoRelativeRect.top < coinRelativeRect.bottom
                ) {
                    coin.remove();
                    addCoin(1);
                }
            });
        }

        function addCoin(amount) {
            coins += amount;
            localStorage.setItem('dinoCoins', coins);
            coinsDisplay.textContent = coins;
            updateSkinSelectionUI();
            updateModeSelectionUI();
        }

        function updateScore() {
            if (!gameOver) {
                score++;
                scoreDisplay.textContent = score;

                if (score % 200 === 0 && score > 0 && gameSpeed < 20) {
                    gameSpeed += 0.5;
                }
            }
        }

        function startGame() {
            gameOver = false;
            score = 0;
            scoreDisplay.textContent = score;
            coinsDisplay.textContent = coins;
            gameOverScreen.style.display = 'none';
            dino.style.bottom = '20px';
            dino.classList.add('running');

            document.querySelectorAll('.obstacle').forEach(o => o.remove());
            document.querySelectorAll('.coin').forEach(c => c.remove());

            const currentModeSettings = modes[currentModeId];
            gameSpeed = 5 * currentModeSettings.speedMultiplier;
            obstacleGenerationInterval = 1500 * currentModeSettings.obstacleFrequency;

            clearInterval(obstacleTimer);
            clearInterval(gameLoopTimer);

            obstacleTimer = setInterval(createObstacle, obstacleGenerationInterval);
            setInterval(createCoin, obstacleGenerationInterval * 0.8);

            gameLoopTimer = setInterval(() => {
                updateScore();
                checkCollision();
            }, 50);

            createObstacle();
        }

        function endGame() {
            gameOver = true;
            clearInterval(obstacleTimer);
            clearInterval(gameLoopTimer);
            dino.classList.remove('running');
            dino.classList.remove('jumping');

            gameOverScreen.style.display = 'block';
            finalScoreDisplay.textContent = score;
            const newCoins = Math.floor(score / 50);
            earnedCoinsDisplay.textContent = newCoins;
            addCoin(newCoins);
        }

        function resetGame() {
            endGame();
            startGame();
        }

        // --- UI & Event Handlers ---

        // Jump mechanism (PC Spacebar and the new button for both mobile/PC)
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' && !gameOver) {
                event.preventDefault();
                jump();
            }
        });
        jumpButtonBelow.addEventListener('click', jump); // Use 'click' for desktop/mobile tap

        // Original game area tap to jump for mobile (can be removed if jumpButtonBelow is preferred)
        gameArea.addEventListener('touchstart', (e) => {
             e.preventDefault(); // Prevent scrolling
             jump();
        });


        restartButton.addEventListener('click', startGame);

        menuButton.addEventListener('click', () => {
            navMenu.classList.add('open');
            overlay.classList.add('active');
        });

        closeMenuButton.addEventListener('click', () => {
            navMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

        overlay.addEventListener('click', () => {
            navMenu.classList.remove('open');
            overlay.classList.remove('active');
        });

        backButton.addEventListener('click', () => {
            history.back();
        });

        // Skin selection logic
        skinItems.forEach(item => {
            item.addEventListener('click', () => {
                const skinId = item.dataset.skinId;
                const skin = skins[skinId];
                const price = skin.price;

                if (unlockedSkins.includes(skinId)) {
                    applySkin(skinId);
                    navMenu.classList.remove('open');
                    overlay.classList.remove('active');
                } else if (coins >= price) {
                    if (confirm(`Buy "${skin.name}" for ${price} coins?`)) {
                        addCoin(-price);
                        unlockedSkins.push(skinId);
                        localStorage.setItem('unlockedSkins', JSON.stringify(unlockedSkins));
                        applySkin(skinId);
                        navMenu.classList.remove('open');
                        overlay.classList.remove('active');
                    }
                } else {
                    alert(`Not enough coins! You need ${price} coins to unlock "${skin.name}". You have ${coins} coins.`);
                }
            });
        });

        // Mode selection logic
        modeItems.forEach(item => {
            item.addEventListener('click', () => {
                const modeId = item.dataset.modeId;
                const mode = modes[modeId];
                const price = mode.price;

                if (unlockedModes.includes(modeId)) {
                    applyMode(modeId);
                    navMenu.classList.remove('open');
                    overlay.classList.remove('active');
                } else if (coins >= price) {
                    if (confirm(`Unlock "${mode.name}" for ${price} coins?`)) {
                        addCoin(-price);
                        unlockedModes.push(modeId);
                        localStorage.setItem('unlockedModes', JSON.stringify(unlockedModes));
                        applyMode(modeId);
                        navMenu.classList.remove('open');
                        overlay.classList.remove('active');
                    }
                } else {
                    alert(`Not enough coins! You need ${price} coins to unlock "${mode.name}". You have ${coins} coins.`);
                }
            });
        });

        // Redeem Code Logic
        redeemButton.addEventListener('click', () => {
            const code = redeemCodeInput.value.trim();
            if (redeemCodes[code]) {
                if (redeemedCodes.includes(code)) {
                    alert('This code has already been redeemed!');
                } else {
                    const amount = redeemCodes[code];
                    addCoin(amount);
                    redeemedCodes.push(code);
                    localStorage.setItem('redeemedCodes', JSON.stringify(redeemedCodes));
                    alert(`Code redeemed successfully! You received ${amount} coins.`);
                    redeemCodeInput.value = ''; // Clear input
                }
            } else {
                alert('Invalid redeem code!');
            }
        });

        // Update UI to show selected skin/mode and locked status
        function updateSkinSelectionUI() {
            skinItems.forEach(item => {
                const skinId = item.dataset.skinId;
                const skin = skins[skinId];
                const priceSpan = item.querySelector('.price');

                item.classList.remove('selected', 'locked');

                if (currentSkinId === skinId) {
                    item.classList.add('selected');
                }
                if (!unlockedSkins.includes(skinId)) {
                    item.classList.add('locked');
                    if (priceSpan) priceSpan.textContent = skin.price;
                } else {
                    if (priceSpan) priceSpan.textContent = 'Owned';
                }
            });
        }

        function updateModeSelectionUI() {
            modeItems.forEach(item => {
                const modeId = item.dataset.modeId;
                const mode = modes[modeId];
                const priceSpan = item.querySelector('.price');

                item.classList.remove('selected', 'locked');

                if (currentModeId === modeId) {
                    item.classList.add('selected');
                }
                if (!unlockedModes.includes(modeId)) {
                    item.classList.add('locked');
                    if (priceSpan) priceSpan.textContent = mode.price;
                } else {
                    if (priceSpan) priceSpan.textContent = 'Owned';
                }
            });
        }

        // --- Initialization ---
        window.onload = () => {
            applySkin(currentSkinId);
            applyMode(currentModeId);
            startGame();
            updateSkinSelectionUI();
            updateModeSelectionUI();
        };
    </script>
</body>
</html>
